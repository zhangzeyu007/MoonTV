# 实施计划

## 任务列表

- [x] 1. 创建事件处理工具库基础结构

  - 在 `src/lib` 目录下创建 `event-handler-utils.ts` 文件
  - 定义核心接口和类型定义
  - 导出所有公共接口
  - _需求: 1.5, 2.1, 4.1_

- [x] 2. 实现 composedPath Polyfill

  - [x] 2.1 实现事件路径检测和 polyfill 应用逻辑

    - 编写 `getEventPath` 函数，支持原生 composedPath、event.path 降级和手动 DOM 遍历
    - 实现循环引用检测，防止无限遍历
    - 添加浏览器能力检测
    - _需求: 1.3, 5.1, 5.4_

  - [x] 2.2 实现安全的 Event.prototype.composedPath 增强
    - 检测并包装原生 composedPath 方法
    - 为不支持的浏览器添加 polyfill
    - 实现安全的 DOM 树遍历逻辑
    - 处理 shadow DOM 和跨域 iframe 场景
    - _需求: 1.3, 5.4_

- [x] 3. 实现事件对象验证器

  - [x] 3.1 创建 EventValidator 类

    - 实现 `isValidEvent` 方法验证事件对象基本结构
    - 实现 `ensureEventProperties` 方法确保必要属性存在
    - 实现 `needsPolyfill` 方法检测是否需要 polyfill
    - _需求: 1.5, 2.2_

  - [x] 3.2 实现事件对象规范化逻辑
    - 处理触摸和鼠标事件的统一化
    - 确保 target 和 currentTarget 属性存在
    - 添加缺失的事件属性默认值
    - _需求: 5.3_

- [x] 4. 实现防抖和节流机制

  - [x] 4.1 创建 EventDebouncer 类

    - 实现基础 debounce 函数，支持 leading 和 trailing 选项
    - 实现 cancel 和 flush 方法
    - 添加定时器清理逻辑防止内存泄漏
    - _需求: 3.2_

  - [x] 4.2 创建 EventThrottler 类
    - 实现基于时间戳的 throttle 函数
    - 实现基于 requestAnimationFrame 的 throttleRAF 函数
    - 确保最后一次调用总是被执行
    - _需求: 3.3, 3.5_

- [x] 5. 实现错误边界和恢复机制

  - [x] 5.1 创建 ErrorBoundary 类

    - 实现 `wrapHandler` 方法用 try-catch 包装事件处理器
    - 实现错误捕获和日志记录逻辑
    - 添加错误上下文信息收集
    - _需求: 2.1, 4.1, 4.2_

  - [x] 5.2 实现错误分类和恢复逻辑

    - 实现 `isRecoverableError` 方法区分可恢复和不可恢复错误
    - 实现 composedPath 错误的特殊处理逻辑
    - 实现错误恢复流程（重试、降级、重置）
    - _需求: 2.2, 2.3, 4.3_

  - [x] 5.3 实现错误频率跟踪和指数退避
    - 创建 ErrorRecord 数据结构记录错误信息
    - 实现错误计数器和时间戳跟踪
    - 实现指数退避算法计算重试延迟
    - 添加错误频率阈值检测
    - _需求: 2.3, 4.5_

- [-] 6. 实现事件处理器管理器

  - [x] 6.1 创建 EventHandlerManager 类

    - 实现事件处理器注册表维护
    - 实现 `register` 方法注册事件处理器
    - 实现 `unregister` 方法注销事件处理器
    - 实现 `cleanup` 方法批量清理
    - _需求: 3.4_

  - [x] 6.2 集成验证、防抖、节流和错误边界
    - 在注册时自动应用事件验证
    - 根据配置应用防抖或节流
    - 自动包装错误边界
    - 实现事件委托支持
    - _需求: 1.1, 1.2, 3.1, 3.4_

- [x] 7. 集成到播放器代码

  - [x] 7.1 重构 play/page.tsx 中的事件处理逻辑

    - 导入事件处理工具库
    - 使用 EventHandlerManager 替换现有的事件监听器注册
    - 应用 composedPath polyfill 到全局 Event.prototype
    - 移除冗余的错误处理代码
    - _需求: 1.1, 1.2, 1.3, 1.4_

  - [x] 7.2 配置不同事件类型的处理策略

    - 为点击事件配置防抖（200ms）
    - 为 timeupdate 事件配置节流（500ms）
    - 为 mousemove/touchmove 配置 RAF 节流
    - 为所有事件启用错误边界
    - _需求: 3.1, 3.2, 3.3, 3.5_

  - [x] 7.3 实现播放器事件监听器重置机制
    - 在检测到连续错误时触发重置
    - 保存播放器状态（时间、音量、速率）
    - 清理旧的事件监听器
    - 重新注册事件监听器
    - 恢复播放器状态
    - _需求: 2.3, 2.4_

- [ ] 8. 实现播放器健康监控系统

  - [x] 8.1 创建 PlayerHealthMonitor 类

    - 实现播放器健康状态跟踪
    - 实现错误严重程度评估逻辑（low/medium/high/critical）
    - 实现播放器响应性检测
    - 实现重建决策逻辑
    - _需求: 3.1, 3.3, 3.4_

  - [x] 8.2 实现健康状态监控逻辑

    - 跟踪错误频率和类型
    - 监控播放器关键功能（播放、暂停、seek）
    - 检测播放器卡死或无响应状态
    - 实现 30 秒重建冷却期
    - _需求: 3.1, 3.2, 3.3_

  - [x] 8.3 集成健康监控到播放器生命周期
    - 在播放器初始化时启动监控
    - 在关键事件中更新健康状态
    - 在错误发生时评估严重程度
    - 在播放器销毁时停止监控
    - _需求: 3.1, 3.5_

- [ ] 9. 实现播放器状态管理系统

  - [x] 9.1 创建 PlayerStateManager 类

    - 定义 PlayerState 接口包含所有关键状态
    - 实现 `captureState` 方法捕获播放器状态
    - 实现 `restoreState` 方法恢复播放器状态
    - 实现状态验证逻辑
    - _需求: 3.2, 3.4_

  - [x] 9.2 实现状态捕获逻辑

    - 捕获视频 URL 和播放时间
    - 捕获音量、播放速率、静音状态
    - 捕获字幕设置
    - 捕获全屏、画中画等 UI 状态
    - 捕获自定义配置
    - _需求: 3.2_

  - [x] 9.3 实现状态恢复逻辑
    - 异步恢复视频 URL
    - 等待视频加载就绪
    - 恢复播放时间（seek）
    - 恢复音量和播放速率
    - 恢复字幕和 UI 状态
    - 处理恢复失败的降级方案
    - _需求: 3.4, 3.5_

- [ ] 10. 实现播放器恢复管理系统

  - [x] 10.1 创建 PlayerRecoveryManager 类

    - 实现播放器销毁流程
    - 实现播放器创建流程
    - 实现完整重建流程
    - 实现重建尝试计数和限制
    - 实现并发重建防护
    - _需求: 3.1, 3.3, 3.4, 3.6_

  - [x] 10.2 实现播放器销毁逻辑

    - 暂停播放
    - 停止并销毁 HLS 实例
    - 清理所有事件监听器
    - 销毁播放器实例
    - 清理 DOM 引用
    - 清理全局引用
    - _需求: 3.3_

  - [x] 10.3 实现播放器创建逻辑

    - 验证容器元素
    - 清空容器
    - 创建新 Artplayer 实例
    - 等待播放器就绪（带超时）
    - 初始化事件处理
    - 保存全局引用
    - _需求: 3.4_

  - [x] 10.4 实现完整重建流程
    - 集成状态捕获
    - 集成播放器销毁
    - 集成播放器创建
    - 集成状态恢复
    - 实现自动播放恢复
    - 实现错误处理和回退
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 11. 实现重建重试和指数退避机制

  - [x] 11.1 实现重试逻辑

    - 实现最多 3 次重建尝试
    - 实现指数退避延迟（2 秒、5 秒、10 秒）
    - 实现递归重试流程
    - 跟踪重建尝试次数
    - _需求: 3.6_

  - [x] 11.2 实现重建失败处理
    - 在所有尝试失败后显示错误页面
    - 提供用户操作选项（刷新、返回）
    - 记录详细错误信息
    - 停止所有恢复尝试
    - _需求: 3.7_

- [ ] 12. 实现用户界面反馈

  - [x] 12.1 实现加载指示器

    - 创建加载指示器组件
    - 显示重建进度（1/3, 2/3, 3/3）
    - 显示加载消息
    - 实现显示和隐藏动画
    - _需求: 3.8_

  - [x] 12.2 实现用户通知

    - 在重建开始时通知用户
    - 在重建成功时通知用户
    - 在重建失败时通知用户
    - 使用播放器 notice API
    - 实现通知防抖
    - _需求: 2.5, 3.8_

  - [x] 12.3 实现错误页面
    - 创建致命错误页面组件
    - 显示错误标题和消息
    - 显示恢复建议
    - 提供操作按钮（刷新、返回）
    - 可选显示错误详情
    - _需求: 3.7, 5.4_

- [x] 13. 集成自动恢复到播放器

  - [x] 13.1 集成健康监控

    - 在播放器初始化时启动健康监控
    - 在错误处理中更新健康状态
    - 在关键操作中检查健康状态
    - _需求: 3.1_

  - [x] 13.2 集成重建触发逻辑

    - 在错误边界中评估是否需要重建
    - 在检测到严重错误时触发重建
    - 在连续错误达到阈值时触发重建
    - 防止频繁重建（冷却期）
    - _需求: 3.1, 3.3_

  - [x] 13.3 更新错误处理流程
    - 更新错误分类逻辑（轻度/中度/严重/致命）
    - 实现分级错误恢复策略
    - 轻度错误：应用 polyfill 和重试
    - 中度错误：重置事件监听器
    - 严重错误：触发播放器重建
    - 致命错误：显示错误页面
    - _需求: 2.1, 2.2, 3.1, 5.4_

- [ ] 14. 实现播放器健康监控和统计系统

  - [x] 14.1 扩展 performanceMonitor 支持播放器健康数据

    - 添加播放器健康状态数据结构
    - 实现重建统计数据收集（总数、成功、失败、平均时间）
    - 实现错误统计数据收集（类型、频率、严重程度）
    - 实现事件处理性能统计
    - 提供数据查询 API
    - _需求: 3.1, 5.2_

  - [x] 14.2 实现重建事件日志系统

    - 记录每次重建事件详情
    - 包含时间戳、成功状态、原因、耗时、错误信息
    - 实现日志持久化（localStorage）
    - 实现日志查询和过滤
    - 支持导出日志用于分析
    - _需求: 5.2_

  - [x] 14.3 实现错误统计和分析

    - 按错误类型统计错误次数
    - 按严重程度分类错误
    - 计算错误率和趋势
    - 识别高频错误模式
    - 生成错误报告
    - _需求: 5.2, 5.5_

- [ ] 15. 创建前端性能监控页面

  - [x] 15.1 扩展现有监控页面显示播放器健康数据

    - 在 `/monitor` 页面添加"播放器健康"标签页
    - 显示播放器健康状态（健康/警告/错误）
    - 显示当前错误计数和类型分布
    - 显示播放器响应性指标
    - _需求: 3.1, 5.2_

  - [ ] 15.2 添加重建统计可视化

    - 显示重建次数统计（总数、成功、失败）
    - 显示重建原因分布饼图
    - 显示重建时间趋势图
    - 显示平均重建耗时
    - 显示最近重建事件列表
    - _需求: 3.1, 5.2_

  - [ ] 15.3 添加错误统计可视化

    - 显示错误类型分布图
    - 显示错误严重程度分布
    - 显示错误频率趋势图
    - 显示高频错误 Top 10
    - 显示最近错误事件列表（带详情）
    - _需求: 5.2, 5.5_

  - [ ] 15.4 添加事件处理性能监控

    - 显示事件触发和执行统计
    - 显示平均事件响应时间
    - 显示事件处理错误率
    - 显示防抖/节流效果统计
    - _需求: 4.1, 5.2_

  - [ ] 15.5 添加实时告警功能
    - 当播放器健康状态异常时显示告警
    - 当错误率超过阈值时显示告警
    - 当重建失败时显示告警
    - 支持告警通知和声音提示
    - _需求: 3.1, 5.2_

- [ ] 16. 性能优化

  - [x] 16.1 优化内存使用

    - 使用 WeakMap 存储事件处理器引用
    - 实现定时器和 RAF 请求的自动清理
    - 定期清理过期的错误记录
    - 添加内存泄漏检测
    - _需求: 4.4, 4.5_

  - [x] 16.2 优化重建性能
    - 优化状态捕获速度
    - 优化播放器销毁流程
    - 优化状态恢复速度
    - 减少重建过程中的阻塞时间
    - _需求: 3.1, 4.1_

- [ ] 17. 浏览器兼容性测试和调整

  - [x] 17.1 添加浏览器检测工具

    - 实现浏览器类型和版本检测
    - 检测 composedPath 支持情况
    - 检测其他相关 API 支持
    - _需求: 6.1, 6.2_

  - [x] 17.2 实现浏览器特定的处理逻辑
    - 为 Safari/WebKit 添加特殊处理
    - 为 Firefox 添加 event.path 降级
    - 确保 Chrome/Edge 使用原生实现
    - 测试重建功能在不同浏览器的兼容性
    - _需求: 6.2, 6.5_

- [ ] 18. 测试和验证

  - [ ] 18.1 编写单元测试

    - 测试 PlayerHealthMonitor 功能
    - 测试 PlayerStateManager 功能
    - 测试 PlayerRecoveryManager 功能
    - 测试错误分类和恢复逻辑
    - _需求: 3.1, 3.2, 3.3_

  - [ ] 18.2 编写集成测试
    - 测试完整重建流程
    - 测试重试机制
    - 测试状态保持和恢复
    - 测试并发重建防护
    - _需求: 3.1, 3.4, 3.5_

- [ ] 19. 文档和代码注释

  - [ ] 19.1 添加代码注释和 JSDoc

    - 为所有新类和方法添加 JSDoc 注释
    - 添加使用示例
    - 说明浏览器兼容性
    - 说明自动恢复机制
    - _需求: 5.2_

  - [ ] 19.2 更新项目文档
    - 在 README 中说明自动恢复功能
    - 添加故障排除指南
    - 记录已知问题和限制
    - 添加配置选项说明
    - 添加监控页面使用说明
    - _需求: 5.4_

- [ ] 9. 性能优化和监控

  - [ ] 9.1 实现事件处理性能监控

    - 创建 EventMetrics 数据结构
    - 记录事件触发和执行次数
    - 测量事件处理响应时间
    - 集成到现有的 performanceMonitor
    - _需求: 3.1_

  - [ ] 9.2 优化内存使用
    - 使用 WeakMap 存储事件处理器引用
    - 实现定时器和 RAF 请求的自动清理
    - 定期清理过期的错误记录
    - 添加内存泄漏检测
    - _需求: 3.4, 3.5_

- [ ] 10. 浏览器兼容性测试和调整

  - [ ] 10.1 添加浏览器检测工具

    - 实现浏览器类型和版本检测
    - 检测 composedPath 支持情况
    - 检测其他相关 API 支持
    - _需求: 5.1, 5.2_

  - [ ] 10.2 实现浏览器特定的处理逻辑
    - 为 Safari/WebKit 添加特殊处理
    - 为 Firefox 添加 event.path 降级
    - 确保 Chrome/Edge 使用原生实现
    - _需求: 5.2, 5.5_

- [x] 11. 文档和代码注释

  - [x] 11.1 添加代码注释和 JSDoc

    - 为所有公共接口添加 JSDoc 注释
    - 添加使用示例
    - 说明浏览器兼容性
    - _需求: 4.2_

  - [x] 11.2 更新项目文档
    - 在 README 中说明事件处理改进
    - 添加故障排除指南
    - 记录已知问题和限制
    - _需求: 4.4_
