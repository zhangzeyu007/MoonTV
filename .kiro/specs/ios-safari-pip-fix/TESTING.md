# iOS Safari 画中画功能测试指南

## 测试环境要求

### iOS Safari 测试

- iOS 设备（iPhone 或 iPad）
- iOS 版本：iOS 9+ （推荐 iOS 14+）
- Safari 浏览器

### 其他浏览器测试

- macOS Safari（验证兼容性）
- Chrome 桌面版和移动版
- Firefox（如适用）

## 测试步骤

### 1. iOS Safari 核心功能测试

#### 测试场景 1：视频加载完成后使用画中画

1. 在 iOS Safari 中打开视频播放页面
2. 等待视频完全加载（进度条可见）
3. 点击画中画按钮
4. **预期结果**：视频成功进入画中画模式，可以切换到其他应用

#### 测试场景 2：视频播放中使用画中画

1. 开始播放视频
2. 在播放过程中点击画中画按钮
3. **预期结果**：视频继续播放并进入画中画模式

#### 测试场景 3：视频暂停时使用画中画

1. 暂停视频
2. 点击画中画按钮
3. **预期结果**：视频进入画中画模式（保持暂停状态）

#### 测试场景 4：退出画中画

1. 在画中画模式下
2. 点击画中画窗口上的关闭按钮或返回应用
3. **预期结果**：视频返回正常播放界面

#### 测试场景 5：视频未就绪时点击

1. 刚进入页面，视频还在加载
2. 立即点击画中画按钮
3. **预期结果**：显示"视频加载中，请稍候..."提示，等待加载后自动进入画中画

### 2. 错误处理测试

#### 测试场景 6：快速连续点击

1. 快速连续点击画中画按钮多次
2. **预期结果**：不会出现错误，状态正确切换

#### 测试场景 7：网络不稳定

1. 在网络较差的环境下播放视频
2. 尝试使用画中画功能
3. **预期结果**：如果视频未就绪，显示友好提示

### 3. 跨浏览器兼容性测试

#### macOS Safari

- [ ] 画中画功能正常工作
- [ ] 按钮显示正确
- [ ] 状态切换流畅

#### Chrome（桌面和移动）

- [ ] 画中画功能正常工作
- [ ] 使用标准 API
- [ ] 与 iOS Safari 体验一致

#### 其他浏览器

- [ ] 不支持时正确隐藏或禁用按钮
- [ ] 显示友好提示

## 调试信息

### 浏览器控制台日志

成功进入画中画时，应该看到类似的日志：

```
[PiP Detection] { isSupported: true, apiType: 'webkit', ... }
[PiP Toggle] Starting { apiType: 'webkit', readyState: 4, ... }
[PiP] WebKit mode change { currentMode: 'inline', targetMode: 'picture-in-picture', ... }
[PiP] WebKit toggle completed { duration: 15 }
[PiP State Change - WebKit] { mode: 'picture-in-picture', isActive: true, ... }
```

### 常见问题排查

#### 问题：点击按钮无响应

- 检查控制台是否有错误日志
- 确认 `apiType` 是否正确检测为 'webkit'
- 检查视频 `readyState` 是否 >= 1

#### 问题：提示"请直接点击按钮"

- 这是 NotAllowedError，表示用户手势上下文丢失
- 确保直接点击按钮，不要通过其他方式触发

#### 问题：提示"视频未就绪"

- 视频还在加载中
- 等待几秒后重试
- 检查网络连接

## 测试结果记录

### iOS Safari

- [ ] iOS 14.x - 测试通过
- [ ] iOS 15.x - 测试通过
- [ ] iOS 16.x - 测试通过
- [ ] iOS 17.x - 测试通过

### 其他浏览器

- [ ] macOS Safari - 测试通过
- [ ] Chrome Desktop - 测试通过
- [ ] Chrome Mobile - 测试通过

## 已知限制

1. iOS Safari 要求视频至少加载到 HAVE_METADATA 状态（readyState >= 1）
2. 画中画功能必须由用户手势触发（点击、触摸）
3. 某些视频格式可能不支持画中画
4. 在低端设备上，画中画性能可能受限

## 反馈问题

如果发现问题，请记录：

1. 设备型号和 iOS 版本
2. 浏览器版本
3. 控制台错误日志
4. 复现步骤
5. 视频 URL（如果可以分享）
