# 实施计划

## 任务列表

- [x] 1. 创建加载监控器（LoadingMonitor）

  - 在 `src/lib` 目录下创建 `loading-monitor.ts` 文件
  - 定义 LoadingState 和 LoadingMonitor 接口
  - 实现加载状态跟踪逻辑
  - 实现超时检测功能
  - 集成网络质量感知
  - _需求: 1.1, 1.2, 1.3, 6.1, 6.2, 6.3, 6.4_

- [x] 1.1 实现加载事件监听

  - 监听 loadstart、waiting、canplay、playing 事件
  - 记录加载开始时间戳
  - 区分初始加载和播放中缓冲
  - 实时计算加载时长
  - _需求: 1.1, 1.2, 7.1, 7.2_

- [x] 1.2 实现超时检测逻辑

  - 实现 isLoadingTimeout 方法
  - 根据网络质量动态调整超时阈值
  - 实现强制超时检测（6 秒）
  - 提供超时原因详情
  - _需求: 1.3, 6.2, 6.3, 6.4, 6.5_

- [x] 1.3 实现网络质量感知

  - 集成现有的网络质量检测
  - 根据网络质量调整超时阈值
  - 优秀/良好: 6 秒，一般: 8 秒，较差: 10 秒
  - 实时更新超时阈值
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 2. 创建切换决策器（SwitchDecisionMaker）

  - 在 `src/lib` 目录下创建 `switch-decision-maker.ts` 文件
  - 定义 SwitchConditions 和 SwitchDecisionMaker 接口
  - 实现多条件评估逻辑
  - 实现冷却期管理
  - 实现错误计数跟踪
  - _需求: 1.3, 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 2.1 实现切换条件评估

  - 实现 shouldSwitchSource 方法
  - 检查加载超时条件
  - 检查冷却期条件
  - 检查最小尝试时间条件
  - 检查错误阈值条件
  - 检查备用源可用性
  - _需求: 1.3, 5.1, 5.2, 5.3, 5.4_

- [x] 2.2 实现冷却期管理

  - 实现 10 秒标准冷却期
  - 实现 5 秒最小源尝试时间
  - 记录上次切换时间
  - 计算冷却剩余时间
  - 致命错误绕过冷却期
  - _需求: 5.1, 5.2, 5.3_

- [x] 2.3 实现错误计数跟踪

  - 跟踪每个源的错误次数
  - 实现 3 次错误阈值
  - 区分可恢复和不可恢复错误
  - 重置错误计数逻辑
  - _需求: 5.4, 5.5, 7.3, 7.4, 7.5_

- [x] 3. 增强源选择器（SourceSelector）

  - 在 `src/lib` 目录下创建 `enhanced-source-selector.ts` 文件
  - 定义 SourceEvaluation 接口
  - 集成现有的 SmartSourceSelector
  - 实现源性能数据库
  - 实现历史数据分析
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 3.1 实现源评估逻辑

  - 评估源的响应时间
  - 评估源的成功率
  - 评估源的历史表现
  - 计算综合评分
  - 排序并返回最佳源
  - _需求: 3.1, 3.2, 3.3_

- [x] 3.2 实现源性能数据库

  - 定义 SourcePerformanceData 数据结构
  - 实现数据持久化（localStorage）
  - 记录每个源的加载时间
  - 记录每个源的成功/失败次数
  - 记录错误类型统计
  - _需求: 3.4, 3.5, 8.2, 8.3_

- [x] 3.3 实现源黑名单机制

  - 标记不可用的源
  - 记录不可用原因
  - 实现黑名单过期机制（1 小时后重试）
  - 在选择时排除黑名单源
  - _需求: 3.4, 4.1, 4.4_

- [x] 4. 创建源切换执行器（SourceSwitchExecutor）

  - 在 `src/lib` 目录下创建 `source-switch-executor.ts` 文件
  - 定义 SwitchContext 接口
  - 实现状态保存和恢复
  - 实现源切换逻辑
  - 实现用户反馈
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 4.1 实现播放器状态捕获

  - 捕获当前播放时间
  - 捕获音量和播放速率
  - 捕获暂停状态
  - 捕获字幕设置
  - 捕获其他播放器配置
  - _需求: 2.1, 2.4_

- [x] 4.2 实现源切换逻辑

  - 保存当前播放器状态
  - 切换到新的视频源
  - 等待新源加载就绪
  - 恢复播放器状态
  - 实现 2 秒切换超时保护
  - _需求: 2.1, 2.2, 2.3_

- [x] 4.3 实现状态恢复逻辑

  - 恢复播放时间（seek）
  - 恢复音量和播放速率
  - 恢复暂停/播放状态
  - 恢复字幕设置
  - 处理恢复失败的情况
  - _需求: 2.3, 2.4_

- [x] 4.4 实现用户反馈

  - 显示"正在切换源"提示
  - 显示切换成功提示（2 秒后消失）
  - 显示切换失败提示
  - 提供切换进度指示
  - _需求: 1.5, 2.5, 10.1, 10.2_

- [x] 5. 创建切换统计器（SwitchStatistics）

  - 在 `src/lib` 目录下创建 `switch-statistics.ts` 文件
  - 定义 SwitchRecord 和 SourceStats 接口
  - 实现切换历史记录
  - 实现统计数据计算
  - 实现数据持久化和导出
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 5.1 实现切换历史记录

  - 记录每次切换的详细信息
  - 包含时间戳、源信息、原因、结果
  - 限制历史记录数量（最多 100 条）
  - 实现历史查询接口
  - _需求: 8.1, 8.2_

- [x] 5.2 实现统计数据计算

  - 计算每个源的成功率
  - 计算平均加载时间
  - 统计错误类型分布
  - 计算整体切换成功率
  - _需求: 8.2, 8.3_

- [x] 5.3 实现数据持久化

  - 使用 localStorage 存储历史数据
  - 实现数据序列化和反序列化
  - 定期清理过期数据
  - 实现数据导出功能（JSON 格式）
  - _需求: 8.4, 8.5_

- [x] 6. 创建自动源切换器（AutoSourceSwitcher）

  - 在 `src/lib` 目录下创建 `auto-source-switcher.ts` 文件
  - 定义 AutoSwitchConfig 接口
  - 协调所有子组件
  - 提供统一的 API 接口
  - 实现事件系统
  - _需求: 1.1, 1.2, 1.3, 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 6.1 实现初始化逻辑

  - 初始化所有子组件
  - 配置加载监控器
  - 配置切换决策器
  - 配置源选择器
  - 配置切换执行器
  - 配置统计器
  - _需求: 1.1, 1.2_

- [x] 6.2 实现自动切换主循环

  - 启动加载监控
  - 定期检查是否需要切换（每秒一次）
  - 评估切换条件
  - 执行源切换
  - 记录切换结果
  - _需求: 1.2, 1.3, 2.1, 2.2_

- [x] 6.3 实现手动切换接口

  - 提供 manualSwitch 方法
  - 显示可用源列表
  - 支持指定目标源
  - 绕过冷却期限制
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 6.4 实现事件系统

  - 定义切换相关事件（switch-start, switch-success, switch-failed, all-sources-failed）
  - 实现事件发射器
  - 支持事件监听和取消
  - 提供事件回调接口
  - _需求: 2.5, 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 7. 集成到播放器页面

  - 修改 `src/app/play/page.tsx`
  - 导入 AutoSourceSwitcher
  - 初始化自动切换器
  - 集成到播放器生命周期
  - 替换现有的简单超时逻辑
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 7.1 初始化自动切换器

  - 在播放器创建后初始化 AutoSourceSwitcher
  - 传入播放器实例和可用源列表
  - 配置超时阈值和冷却期
  - 启动自动切换
  - _需求: 1.1, 1.2_

- [x] 7.2 集成切换事件处理

  - 监听 switch-start 事件
  - 监听 switch-success 事件
  - 监听 switch-failed 事件
  - 监听 all-sources-failed 事件
  - 更新 UI 状态
  - _需求: 1.5, 2.5, 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 7.3 替换现有超时逻辑

  - 移除现有的简单超时检测代码
  - 使用 AutoSourceSwitcher 的监控和决策
  - 保留必要的错误处理逻辑
  - 确保向后兼容
  - _需求: 1.1, 1.2, 1.3_

- [x] 7.4 实现手动切换 UI

  - 在播放器控制栏添加"切换源"按钮
  - 实现源列表弹窗
  - 显示每个源的质量信息
  - 处理用户选择
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 8. 实现错误处理增强

  - 增强现有的错误处理逻辑
  - 区分不同类型的加载失败
  - 实现分级恢复策略
  - 集成到自动切换流程
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5, 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 8.1 实现初始加载超时处理

  - 检测初始加载超时
  - 立即触发源切换
  - 记录超时原因
  - _需求: 7.1, 7.2_

- [x] 8.2 实现播放中缓冲超时处理

  - 检测播放中缓冲超时
  - 先尝试恢复当前源
  - 失败后触发源切换
  - _需求: 7.2, 7.3_

- [x] 8.3 实现网络断开处理

  - 检测网络离线
  - 暂停自动切换
  - 等待网络恢复
  - 自动重试当前源
  - _需求: 7.4_

- [x] 8.4 实现 HLS 错误处理

  - 检测 HLS 片段加载失败
  - 先重试当前片段
  - 多次失败后切换源
  - _需求: 7.5_

- [x] 8.5 实现所有源失败处理

  - 检测所有源都已尝试
  - 停止自动切换
  - 显示错误页面
  - 提供重试和返回选项
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 9. 集成到性能监控系统

  - 修改 `src/lib/performance-monitor.ts`
  - 添加源切换相关指标
  - 记录切换历史
  - 提供统计数据查询
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 9.1 添加切换指标

  - 记录切换频率
  - 记录切换成功率
  - 记录平均切换时间
  - 记录源性能排名
  - _需求: 8.1, 8.2, 8.3_

- [x] 9.2 实现数据可视化接口

  - 提供切换历史查询 API
  - 提供源统计数据 API
  - 提供网络质量分布 API
  - 集成到监控页面
  - _需求: 8.4, 8.5_

- [x] 10. 实现用户界面增强

  - 优化切换提示样式
  - 实现源列表界面
  - 实现错误页面
  - 提供用户控制选项
  - _需求: 1.5, 2.5, 9.1, 9.2, 9.3, 9.4, 9.5, 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 10.1 优化切换提示

  - 设计友好的切换提示样式
  - 显示切换进度
  - 显示目标源信息
  - 自动消失动画
  - _需求: 1.5, 2.5_

- [x] 10.2 实现源列表界面

  - 设计源列表弹窗
  - 显示源名称和质量评分
  - 显示延迟和可用性状态
  - 支持源选择和切换
  - _需求: 9.2, 9.3, 9.4_

- [x] 10.3 实现错误页面

  - 设计友好的错误页面
  - 显示错误原因和建议
  - 提供重试和返回按钮
  - 可选显示详细错误信息
  - _需求: 4.2, 4.3, 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 11. 性能优化

  - 优化监控频率
  - 优化切换速度
  - 优化内存使用
  - 优化网络请求
  - _需求: 2.2, 3.1, 3.2, 3.3_

- [x] 11.1 优化监控性能

  - 使用节流减少检查频率（每秒一次）
  - 避免重排重绘
  - 使用 requestAnimationFrame 优化 UI
  - 及时清理事件监听器
  - _需求: 2.2_

- [x] 11.2 优化切换性能

  - 预加载备用源
  - 使用 HLS 预加载
  - 复用播放器实例
  - 批量更新状态
  - _需求: 2.2, 2.3, 3.1_

- [x] 11.3 优化内存使用

  - 限制历史记录数量（100 条）
  - 定期清理过期数据
  - 使用 WeakMap 存储临时数据
  - 及时释放资源
  - _需求: 8.4, 8.5_

- [x] 11.4 优化网络请求

  - 并发测试多个源（最多 3 个）
  - 使用 HEAD 请求测试可用性
  - 实施请求超时保护
  - 复用 TCP 连接
  - _需求: 3.1, 3.2, 3.3_

- [x] 12. 浏览器兼容性测试

  - 测试 Chrome/Edge 兼容性
  - 测试 Safari 兼容性
  - 测试 Firefox 兼容性
  - 测试移动浏览器兼容性
  - _需求: 所有需求_

- [x] 12.1 实现浏览器检测

  - 检测浏览器类型和版本
  - 检测 HLS 支持情况
  - 检测 MediaSource 支持
  - _需求: 所有需求_

- [x] 12.2 实现浏览器特定处理

  - Safari 增加超时阈值
  - 移动设备启用网络自适应
  - 调整配置以适应不同浏览器
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 13. 编写测试

  - 编写单元测试
  - 编写集成测试
  - 编写端到端测试
  - 进行性能测试
  - _需求: 所有需求_

- [x] 13.1 编写单元测试

  - 测试 LoadingMonitor
  - 测试 SwitchDecisionMaker
  - 测试 SourceSelector
  - 测试 SourceSwitchExecutor
  - 测试 SwitchStatistics
  - _需求: 所有需求_

- [x] 13.2 编写集成测试

  - 测试完整切换流程
  - 测试多次切换场景
  - 测试网络环境变化
  - 测试边界情况
  - _需求: 所有需求_

- [x] 13.3 编写端到端测试

  - 测试用户场景
  - 测试性能指标
  - 测试兼容性
  - _需求: 所有需求_

- [x] 14. 文档和代码注释

  - 添加代码注释和 JSDoc
  - 更新项目文档
  - 编写使用指南
  - 记录已知问题
  - _需求: 所有需求_

- [x] 14.1 添加代码注释

  - 为所有公共接口添加 JSDoc
  - 添加使用示例
  - 说明配置选项
  - 记录注意事项
  - _需求: 所有需求_

- [x] 14.2 更新项目文档

  - 在 README 中说明自动切换功能
  - 添加配置指南
  - 添加故障排除指南
  - 记录已知问题和限制
  - _需求: 所有需求_
